<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Aulas y Dispositivos - IoT</title>

  <!-- Bootstrap & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="css/aulas.css" />
</head>

<body>

<header>
  <div class="container d-flex justify-content-between align-items-center">
    <h4>Aulas y Dispositivos</h4>
    <a href="dashboard.html" class="btn-back"><i class="bi bi-arrow-left"></i> Volver</a>
  </div>
</header>

<div class="container mt-4">

  <div class="section-header">
    <div class="title-line"></div>
    <h5 class="section-title">Administrar Aulas / Dispositivos</h5>
  </div>

  <div class="d-flex mb-3 justify-content-between flex-wrap">
    <div class="d-flex gap-2 flex-wrap">
      <input id="searchAula" class="form-control" style="max-width:280px" placeholder="Buscar aula o ID...">
    </div>
    <button id="btnAddAula" class="btn btn-main">+ Agregar Aula</button>
  </div>

  <div class="content-box">
    <div class="scroll-area">
      <table class="table table-sm">
        <thead>
          <tr>
            <th>Edificio</th>
            <th>Aula</th>
            <th>ID del Dispositivo</th>
            <th>Estado</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="tbAulas"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- MODAL -->
<div class="modal fade" id="modalAula" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title">Aula / Dispositivo</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <form id="formAula">
          <input type="hidden" id="aulaId">
          <label class="form-label">Código de Aula</label>
          <input id="aulaName" class="form-control" required placeholder="Ej: 3-105">

          <label class="form-label mt-2">ID del Dispositivo</label>
          <input id="aulaDev" class="form-control" required placeholder="Ej: ESP-105-A">

          <label class="form-label mt-2">Estado</label>
          <select id="aulaEstado" class="form-select">
            <option value="Activo">Activo</option>
            <option value="Desconectado">Desconectado</option>
          </select>
        </form>
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button class="btn btn-main" id="saveAula">Guardar</button>
      </div>

    </div>
  </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<!-- Simulated backend -->
<script src="js/simdb.js"></script>
<script src="js/aulas.api.js"></script>

<script>
function getAulas(){ return JSON.parse(localStorage.getItem("aulas") || "[]"); }
function saveAulas(arr){ localStorage.setItem("aulas", JSON.stringify(arr)); }

if(!localStorage.getItem("aulas")){
  saveAulas([
    {id:"a1", aula:"3-105", device:"ESP-105-A", estado:"Activo"},
    {id:"a2", aula:"3-201", device:"ESP-201-B", estado:"Desconectado"}
  ]);
}

function renderAulas(){
  const tbody = document.getElementById("tbAulas");
  const search = document.getElementById("searchAula").value.toLowerCase();
  tbody.innerHTML = "";

  const edifFilter = ""; // filtro de edificio eliminado
  getAulas().forEach(a=>{
    if(search &&
       !a.aula.toLowerCase().includes(search) &&
       !a.device.toLowerCase().includes(search)
    ) return;

    const edificio = (a.aula||'').split('-')[0] || '-';
    if(edifFilter && edificio !== edifFilter) return;
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${edificio}</td>
      <td>${a.aula}</td>
      <td>${a.device}</td>
      <td>${a.estado === "Activo"
          ? '<span class="badge-activo">Activo</span>'
          : '<span class="badge-off">Desconectado</span>'}
      </td>
      <td>
        <button class="btn btn-sm btn-outline-primary" onclick="editAula('${a.id}')">Editar</button>
        <button class="btn btn-sm btn-outline-danger ms-2" onclick="delAula('${a.id}')">Eliminar</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

renderAulas();

const modalAula = new bootstrap.Modal(document.getElementById("modalAula"));

document.getElementById("btnAddAula").addEventListener("click", ()=>{
  document.getElementById("formAula").reset();
  document.getElementById("aulaId").value = "";
  modalAula.show();
});

function editAula(id){
  const a = getAulas().find(x=>x.id===id);
  document.getElementById("aulaId").value = a.id;
  document.getElementById("aulaName").value = a.aula;
  document.getElementById("aulaDev").value = a.device;
  document.getElementById("aulaEstado").value = a.estado;
  modalAula.show();
}

function delAula(id){
  if(!confirm("¿Eliminar aula?")) return;
  saveAulas(getAulas().filter(x=>x.id!==id));
  renderAulas();
}

document.getElementById("saveAula").addEventListener("click", ()=>{
  const id = document.getElementById("aulaId").value;
  const aula = document.getElementById("aulaName").value;
  const device = document.getElementById("aulaDev").value;
  const estado = document.getElementById("aulaEstado").value;
  const edificio = (aula||'').split('-')[0] || '';
  let aulas = getAulas();

  if(id){
    const i = aulas.findIndex(x=>x.id===id);
    aulas[i] = {id,aula,device,estado,edificio};
  } else {
    aulas.push({id:"a"+Date.now(),aula,device,estado,edificio});
  }

  saveAulas(aulas);
  modalAula.hide();
  renderAulas();
});

document.getElementById("searchAula").addEventListener("input", renderAulas);
// filtro de edificio eliminado
</script>

</body>
</html>
