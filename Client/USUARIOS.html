<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Gestión de Usuarios - Sistema IoT</title>

  <!-- Bootstrap y estilos -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/usuarios.css" />
  <style>
    /* estilos específicos o temporales pueden quedar aquí si no están en usuarios.css */
  </style>
</head>

<body>

<!-- Encabezado con botón para volver al dashboard -->
<header>
  <div class="container d-flex justify-content-between align-items-center">
    <h4>Gestión de Usuarios</h4>
    <a href="dashboard.html" class="btn-back"><i class="bi bi-arrow-left"></i> Volver</a>
  </div>
</header>

<div class="container mt-4">

  <!-- Título de sección -->
  <div class="section-header">
    <div class="title-line"></div>
    <h5 class="section-title">Administrar Usuarios</h5>
  </div>

  <!-- Barra de búsqueda y botón para agregar usuario -->
  <div class="d-flex mb-3 justify-content-between flex-wrap">
    <input id="searchUser" class="form-control" style="max-width:280px" placeholder="Buscar por nombre o cédula...">
    <button class="btn btn-main" id="btnAddUser">+ Agregar Usuario</button>
  </div>

  <!-- Tabla de usuarios -->
  <div class="content-box">
    <div class="scroll-area">
      <table class="table table-sm">
        <thead>
          <tr>
            <th>Nombre</th>
            <th>Cédula</th>
            <th>Rol</th>
            <th>Grupo</th>
            <th>Correo</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="tbUsers"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- Modal para agregar/editar usuario -->
<div class="modal fade" id="modalUser" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title">Usuario</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <form id="formUser">
          <input type="hidden" id="userId">

          <label class="form-label">Nombre</label>
          <input id="userName" class="form-control" required>

          <label class="form-label mt-2">Cédula (Panamá)</label>
          <input id="userCedula" class="form-control" placeholder="8-1234-5678" required>

          <label class="form-label mt-2">Rol</label>
          <select id="userRol" class="form-select" required>
            <option>Estudiante</option>
            <option>Docente</option>
          </select>

          <label class="form-label mt-2">Grupo (1GS123)</label>
          <input id="userGrupo" class="form-control">

          <label class="form-label mt-2">Correo</label>
          <input id="userCorreo" type="email" class="form-control">

        </form>
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button class="btn btn-main" id="saveUser">Guardar</button>
      </div>

    </div>
  </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- API de usuarios (conexión al backend) -->
<script src="js/usuarios.api.js"></script>
<script>
// Función para renderizar la tabla de usuarios
async function renderUsers(){
  const tbody = document.getElementById("tbUsers");
  const search = document.getElementById("searchUser").value.toLowerCase();

  tbody.innerHTML = "";

  let users = [];
  try {
    // Llama al backend para obtener usuarios (puede filtrar por búsqueda)
    users = await UsuariosAPI.listar({ search });
  } catch (e) {
    tbody.innerHTML = `<tr><td colspan="6">Error al cargar usuarios</td></tr>`;
    return;
  }

  // Recorre y muestra cada usuario en la tabla
  users.forEach(u=>{
    if(search &&
      !u.nombre.toLowerCase().includes(search) &&
      !u.cedula.toLowerCase().includes(search)
    ) return;

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${u.nombre}</td>
      <td>${u.cedula}</td>
      <td>${u.rol}</td>
      <td>${u.grupo || "-"}</td>
      <td>${u.correo || "-"}</td>
      <td>
        <button class="btn btn-sm btn-outline-primary" onclick="editUser('${u.id}')">Editar</button>
        <button class="btn btn-sm btn-outline-danger ms-2" onclick="delUser('${u.id}')">Eliminar</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

/* ----------------------------- MODAL ------------------------------*/
// Inicializa el modal de usuario
const modalUser = new bootstrap.Modal(document.getElementById("modalUser"));

// Botón para abrir el modal y limpiar el formulario
document.getElementById("btnAddUser").addEventListener("click", ()=>{
  document.getElementById("formUser").reset();
  document.getElementById("userId").value = "";
  modalUser.show();
});

// Función para editar usuario (llena el modal con los datos)
window.editUser = async function(id){
  const users = await UsuariosAPI.listar();
  const u = users.find(x=>x.id === id);
  document.getElementById("userId").value = u.id;
  document.getElementById("userName").value = u.nombre;
  document.getElementById("userCedula").value = u.cedula;
  document.getElementById("userRol").value = u.rol;
  document.getElementById("userGrupo").value = u.grupo;
  document.getElementById("userCorreo").value = u.correo;
  modalUser.show();
}

// Función para eliminar usuario
window.delUser = async function(id){
  if(!confirm("¿Eliminar usuario?")) return;
  await UsuariosAPI.eliminar(id);
  renderUsers();
}

/* ----------------------------- GUARDAR USUARIO ------------------------------*/
// Botón para guardar usuario (nuevo o editado)
document.getElementById("saveUser").addEventListener("click", async ()=>{
  const id = document.getElementById("userId").value;
  const nombre = document.getElementById("userName").value;
  const cedula = document.getElementById("userCedula").value;
  const rol = document.getElementById("userRol").value;
  const grupo = document.getElementById("userGrupo").value;
  const correo = document.getElementById("userCorreo").value;

  // Valida la cédula antes de guardar
  if(!UsuariosAPI.validarCedula(cedula)){
    alert("Cédula inválida. Formato correcto: X-XXXX-XXXX");
    return;
  }

  try {
    // Si hay id, actualiza; si no, crea nuevo usuario
    if(id){
      await UsuariosAPI.actualizar(id, { nombre, cedula, rol, grupo, correo });
    } else {
      await UsuariosAPI.crear({ nombre, cedula, rol, grupo, correo });
    }
    modalUser.hide();
    renderUsers();
  } catch(e) {
    alert(e.message || "Error al guardar usuario");
  }
});

// Evento para buscar usuarios mientras se escribe
document.getElementById("searchUser").addEventListener("input", renderUsers);

// Llama a renderUsers al cargar la página para mostrar la lista inicial
renderUsers();
</script>

</body>
</html>
