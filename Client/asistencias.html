<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Asistencias IoT</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/asistencias.css" />
</head>

<body>
  <header>
    <div class="container d-flex justify-content-between align-items-center">
  <h4 class="m-0">Sistema de Asistencias</h4>
  <a href="dashboard.html" class="btn-back"><i class="bi bi-arrow-left"></i> Volver</a>
    </div>
  </header>

  <div class="container mt-4">
    <!-- controles superiores -->
    <div class="d-flex gap-2 mb-4 flex-wrap align-items-center">
      <div>
        <label for="filterDate" class="form-label me-2">Filtrar por fecha:</label>
        <input type="date" id="filterDate" class="form-control form-control-sm" style="width:170px">
      </div>

      <!--BOTONES IMPORTANTES-->
      <div class="ms-auto">
        <button id="exportAll" class="btn btn-secondary btn-sm export-btn">Exportar todo (CSV)</button>
        <button id="clearAll" class="btn btn-danger btn-sm">Limpiar registros</button>
      </div>
    </div>

    <div class="row g-4">
      <!-- ESTUDIANTES -->
      <div class="col-md-6">
        <div class="content-box">
          <div class="section-header mb-3">
            <div class="title-line"></div>
            <h5 class="section-title">
              <span style="font-size:20px; margin-right:6px;">ðŸŽ“</span> Estudiantes
            </h5>
          </div>

          <div class="filters-area">
            <input id="filterEst" class="form-control form-control-sm" style="width:170px" placeholder="Buscar...">
            <select id="filterEstEstado" class="form-select form-select-sm" style="width:150px">
              <option value="">Todos</option>
              <option value="A tiempo">A tiempo</option>
              <option value="Tarde">Tarde</option>
              <option value="Ausente">Ausente</option>
              <option value="Justificado">Justificado</option>
              <option value="CumpliÃ³ horario">CumpliÃ³ horario</option>
            </select>
            <button id="exportEst" class="btn btn-outline-dark btn-sm export-btn">Exportar estudiantes</button>
          </div>

          <div style="overflow:auto" class="mt-3">
            <table class="table table-bordered mb-0">
              <thead>
                <tr>
                  <th>Nombre</th>
                  <th class="text-center">CÃ©dula</th>
                  <th>Curso</th>
                  <th>Aula</th>
                  <th>Tipo</th>
                  <th>Fecha</th>
                  <th>Hora</th>
                  <th>Estado</th>
                  <th>AcciÃ³n</th>
                </tr>
              </thead>
              <tbody id="tbEst"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- DOCENTES -->
      <div class="col-md-6">
        <div class="content-box">
          <div class="section-header mb-3">
            <div class="title-line"></div>
            <h5 class="section-title">
              <span style="font-size:20px; margin-right:6px;">ðŸ“˜</span> Docentes
            </h5>
          </div>

    <div class="filters-area">
      <input id="filterDoc" class="form-control form-control-sm" style="width:170px" placeholder="Buscar...">
      <select id="filterDocEstado" class="form-select form-select-sm" style="width:150px">
        <option value="">Todos</option>
        <option value="A tiempo">A tiempo</option>
        <option value="Tarde">Tarde</option>
        <option value="Ausente">Ausente</option>
        <option value="Justificado">Justificado</option>
        <option value="CumpliÃ³ horario">CumpliÃ³ horario</option>
      </select>
      <button id="exportDoc" class="btn btn-outline-dark btn-sm export-btn">Exportar docentes</button>
    </div>

          <div style="overflow:auto" class="mt-3">
            <table class="table table-bordered mb-0">
              <thead>
                <tr>
                  <th>Nombre</th>
                  <th class="text-center">CÃ©dula</th>
                  <th>Aula</th>
                  <th>Tipo</th>
                  <th>Fecha</th>
                  <th>Hora</th>
                  <th>Estado</th>
                  <th>AcciÃ³n</th>
                </tr>
              </thead>
              <tbody id="tbDoc"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Justificantes -->
    <div class="mt-4 content-box">
      <div class="section-header mb-3">
        <div class="title-line"></div>
        <h5 class="section-title">
          <span style="font-size:20px; margin-right:6px;">ðŸ“„</span> Justificantes registrados
        </h5>
      </div>

      <div class="just-box">
        <table class="table table-bordered" id="tbJust">
          <thead>
            <tr>
              <th>Nombre</th>
              <th>Rol</th>
              <th>Fecha registro</th>
              <th>Fecha doc</th>
              <th>Motivo</th>
              <th>Archivo</th>
              <th>AcciÃ³n</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- MODALES (justificante) -->
  <div class="modal fade" id="modalJust" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">

        <div class="modal-header">
          <h5 class="modal-title">Subir justificante</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">
          <form id="formJust">
            <input type="hidden" id="just_regId">
            <div class="row g-2">
              <div class="col-md-6">
                <label class="form-label">Nombre</label>
                <input id="just_nombre" class="form-control" required readonly>
              </div>

              <div class="col-md-3">
                <label class="form-label">Rol</label>
                <input id="just_rol" class="form-control" required readonly>
              </div>

              <div class="col-md-3">
                <label class="form-label">Fecha registro</label>
                <input id="just_fechaReg" class="form-control" required readonly>
              </div>

              <div class="col-md-6">
                <label class="form-label">Fecha del documento</label>
                <input id="just_fechaDoc" type="date" class="form-control" required>
              </div>

              <div class="col-md-6">
                <label class="form-label">NÃºmero acta / referencia</label>
                <input id="just_ref" class="form-control">
              </div>

              <div class="col-12">
                <label class="form-label">Motivo / ObservaciÃ³n</label>
                <textarea id="just_motivo" class="form-control" rows="3" required></textarea>
              </div>

              <div class="col-md-8">
                <label class="form-label">Archivo (opcional)</label>
                <input id="just_file" type="file" class="form-control" accept=".pdf,image/*">
              </div>

              <div class="col-md-4 d-flex align-items-end">
                <button id="saveJust" type="submit" class="btn btn-primary w-100">Guardar justificante</button>
              </div>
            </div>
          </form>
        </div>

      </div>
    </div>
  </div>

  <div class="modal fade" id="modalJustView" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Detalle justificante</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="justDetailBody"></div>
      </div>
    </div>
  </div>

  <!-- bootstrap -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <!-- API real -->
  <script src="js/asistencias.api.js"></script>

  <script>
    let currentRegs = [];

    // --- badges segÃºn estado ---
    function stateBadge(status) {
      if (status === 'A tiempo') return `<span class="badge-a">${status}</span>`;
      if (status === 'Tarde') return `<span class="badge-t">${status}</span>`;
      if (status === 'Ausente') return `<span class="badge-f">${status}</span>`;
      if (status === 'Justificado') return `<span class="badge-j">${status}</span>`;
      if (status === 'CumpliÃ³ horario') return `<span class="badge-ok">${status}</span>`;
      return `<span>${status}</span>`;
    }

    // --- celda de acciÃ³n (selector + botÃ³n subir justificante) ---
    function actionCell(reg) {
      const sel = `
        <select data-id="${reg.id}" class="form-select form-select-sm sel-state" style="width:160px;display:inline-block">
          <option ${reg.estado === 'A tiempo' ? 'selected' : ''}>A tiempo</option>
          <option ${reg.estado === 'Tarde' ? 'selected' : ''}>Tarde</option>
          <option ${reg.estado === 'Ausente' ? 'selected' : ''}>Ausente</option>
          <option ${reg.estado === 'Justificado' ? 'selected' : ''}>Justificado</option>
          <option ${reg.estado === 'CumpliÃ³ horario' ? 'selected' : ''}>CumpliÃ³ horario</option>
        </select>`;
      const btnJust = `
        <button data-id="${reg.id}" class="btn btn-sm btn-primary btn-just small-btn ms-2"
          ${!(reg.estado === 'Tarde' || reg.estado === 'Ausente' || reg.estado === 'Justificado') ? 'style="display:none"' : ''}>
          Subir excusa
        </button>`;
      return `<div class="action-cell">${sel + btnJust}</div>`;
    }

    // --- renderizar tablas estudiantiles y docentes ---
    async function renderAllTables() {
      const regs = await AsistenciasAPI.listRegistros(); // usa backend real
      currentRegs = regs;
      const $tbEst = document.getElementById('tbEst');
      const $tbDoc = document.getElementById('tbDoc');
      $tbEst.innerHTML = '';
      $tbDoc.innerHTML = '';

      const filterEstText = document.getElementById('filterEst').value.toLowerCase();
      const filterEstEstado = document.getElementById('filterEstEstado').value;
      const filterDocText = document.getElementById('filterDoc').value.toLowerCase();
      const filterDocEstado = document.getElementById('filterDocEstado').value;

      regs.forEach(r => {
        if (r.rol === 'Estudiante') {
          if (filterEstText && !r.nombre.toLowerCase().includes(filterEstText) && !(r.cedula || '').toLowerCase().includes(filterEstText)) return;
          if (filterEstEstado && r.estado !== filterEstEstado) return;

          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${r.nombre}</td>
            <td class="td-cedula text-center">${r.cedula || '-'}</td>
            <td>${r.grupo || '-'}</td>
            <td>${r.aula_id || '-'}</td>
            <td>${r.tipo}</td>
            <td>${r.fecha}</td>
            <td>${r.hora}</td>
            <td class="state-cell">${stateBadge(r.estado)}</td>
            <td>${actionCell(r)}</td>
          `;
          $tbEst.appendChild(tr);
        } else { // docente
          if (filterDocText && !r.nombre.toLowerCase().includes(filterDocText) && !(r.cedula || '').toLowerCase().includes(filterDocText)) return;
          if (filterDocEstado && r.estado !== filterDocEstado) return;

          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${r.nombre}</td>
            <td class="td-cedula text-center">${r.cedula || '-'}</td>
            <td>${r.aula_id || '-'}</td>
            <td>${r.tipo}</td>
            <td>${r.fecha}</td>
            <td>${r.hora}</td>
            <td class="state-cell">${stateBadge(r.estado)}</td>
            <td>${actionCell(r)}</td>
          `;
          $tbDoc.appendChild(tr);
        }
      });

      renderJustificantesTable();
    }

    // --- cambiar estado desde selector ---
    document.addEventListener('change', async function (ev) {
      if (ev.target && ev.target.classList.contains('sel-state')) {
        const id = ev.target.getAttribute('data-id');
        const newState = ev.target.value;
        try {
          await AsistenciasAPI.updateRegistro(id, { estado: newState }); // backend real
          renderAllTables();
          if (newState === 'Justificado') openJustModalFor(id);
        } catch (e) {
          alert("Error al actualizar estado");
        }
      }
    });

    // --- abrir modal justificante ---
    document.addEventListener('click', function (ev) {
      if (ev.target && ev.target.classList.contains('btn-just')) {
        openJustModalFor(ev.target.getAttribute('data-id'));
      }
    });

    function openJustModalFor(id) {
      // Usa los registros reales obtenidos del backend
      const reg = currentRegs.find(x => String(x.id) === String(id));
      if (!reg) return;
      document.getElementById('just_regId').value = id;
      document.getElementById('just_nombre').value = reg.nombre;
      document.getElementById('just_rol').value = reg.rol;
      document.getElementById('just_fechaReg').value = reg.fecha;
      document.getElementById('just_fechaDoc').value = new Date().toISOString().slice(0, 10);
      document.getElementById('just_ref').value = '';
      document.getElementById('just_motivo').value = '';
      document.getElementById('just_file').value = '';
      new bootstrap.Modal(document.getElementById('modalJust')).show();
    }

    // --- guardar justificante (archivo opcional) ---
    document.getElementById('formJust').addEventListener('submit', async function (e) {
      e.preventDefault();
      const regId = document.getElementById('just_regId').value;
      const fechaReg = document.getElementById('just_fechaReg').value;
      const fechaDoc = document.getElementById('just_fechaDoc').value;
      const motivo = document.getElementById('just_motivo').value;

      // Busca el registro de asistencia para obtener usuario_id
      const reg = currentRegs.find(x => String(x.id) === String(regId));
      if (!reg) return alert("No se encontrÃ³ el registro de asistencia");
      const usuarioId = reg.usuario_id;

      // Payload con los nombres correctos
      const payload = {
        asistencia_id: Number(regId),
        usuario_id: Number(usuarioId),
        fecha_registro: fechaReg,
        fecha_documento: fechaDoc,
        motivo: motivo
      };

      try {
        await AsistenciasAPI.createJustificante(payload); // <-- usa la API real
        bootstrap.Modal.getInstance(document.getElementById('modalJust')).hide();
        renderJustificantesTable();
      } catch (err) {
        alert('Error al guardar justificante');
      }
    });

    // --- render justificantes ---
    async function renderJustificantesTable() {
      const justs = await AsistenciasAPI.listJustificantes();
      const tbody = document.querySelector('#tbJust tbody');
      tbody.innerHTML = '';
      justs.forEach(j => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${j.nombre}</td>
          <td>${j.rol || ''}</td>
          <td>${j.fecha_registro}</td>
          <td>${j.fecha_documento}</td>
          <td>${j.motivo}</td>
          <td><i>Sin archivo</i></td>
          <td>
            <button data-id="${j.id}" class="btn btn-sm btn-outline-primary view-just">Ver</button>
            <button data-id="${j.id}" class="btn btn-sm btn-outline-danger del-just ms-1">Eliminar</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    // ver/eliminar justificantes
    document.addEventListener('click', async function (ev) {
      // Ver justificante
      if (ev.target && ev.target.classList.contains('view-just')) {
        const id = ev.target.getAttribute('data-id');
        const j = await AsistenciasAPI.getJustificante(id);
        document.getElementById('justDetailBody').innerHTML = `
          <h5>${j.nombre} â€” ${j.rol}</h5>
          <p><strong>Fecha registro:</strong> ${j.fecha_registro}</p>
          <p><strong>Fecha doc:</strong> ${j.fecha_documento}</p>
          <p><strong>Motivo:</strong><br>${j.motivo}</p>
          <p><strong>Archivo:</strong><br>${j.archivo_nombre ? `<a href="${j.archivo_url}" download="${j.archivo_nombre}">${j.archivo_nombre}</a>` : '<i>No adjuntado</i>'}</p>
        `;
        new bootstrap.Modal(document.getElementById('modalJustView')).show();
      }

      // Eliminar justificante
      if (ev.target && ev.target.classList.contains('del-just')) {
        const id = ev.target.getAttribute('data-id');
        if (!confirm('Â¿Eliminar justificante?')) return;
        await AsistenciasAPI.deleteJustificante(id);
        renderJustificantesTable();
      }
    });

    // --- export CSV (incluye cÃ©dula) ---
    // (ExportaciÃ³n intacta; actualmente usa getRegistrations: cÃ¡mbialo a backend cuando quieras)
    function exportCSV(filename, csvString) {
      const blob = new Blob([csvString], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    document.getElementById('exportAll').addEventListener('click', async () => {
      const csv = await AsistenciasAPI.makeCSVAll();
      if (!csv.trim()) return alert('No hay registros para exportar');
      exportCSV('asistencias_completo.csv', csv.split('\n').map(line => line.split(',')), ['nombre','cedula','rol','grupo','aula_id','tipo','fecha','hora','estado']);
    });

    document.getElementById('exportEst').addEventListener('click', async () => {
      const csv = await AsistenciasAPI.makeCSVEst();
      if (!csv.trim()) return alert('No hay registros de estudiantes');
      exportCSV('asistencias_estudiantes.csv', csv.split('\n').map(line => line.split(',')), ['nombre','cedula','grupo','aula_id','tipo','fecha','hora','estado']);
    });

    document.getElementById('exportDoc').addEventListener('click', async () => {
      const csv = await AsistenciasAPI.makeCSVDoc();
      if (!csv.trim()) return alert('No hay registros de docentes');
      exportCSV('asistencias_docentes.csv', csv.split('\n').map(line => line.split(',')), ['nombre','cedula','aula_id','tipo','fecha','hora','estado']);
    });

    // filtros
    document.getElementById('filterEst').addEventListener('input', renderAllTables);
    document.getElementById('filterEstEstado').addEventListener('change', renderAllTables);
    document.getElementById('filterDoc').addEventListener('input', renderAllTables);
    document.getElementById('filterDocEstado').addEventListener('change', renderAllTables);

    document.getElementById('clearAll').addEventListener('click', async () => {
      if (confirm('Â¿EstÃ¡s seguro de que deseas eliminar todos los registros?')) {
        try {
          await AsistenciasAPI.deleteAllRegistros(); // backend real
          renderAllTables();
          alert('Todos los registros han sido eliminados de la base de datos.');
        } catch (e) {
          alert('Error al eliminar registros.');
        }
      }
    });

    // inicial
    renderAllTables();
  </script>
</body>

</html>
