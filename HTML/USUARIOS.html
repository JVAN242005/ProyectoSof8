<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Gestión de Usuarios - Sistema IoT</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="css/usuarios.css" />
  <style>
    /* estilos específicos o temporales pueden quedar aquí si no están en usuarios.css */
  </style>
</head>

<body>

<header>
  <div class="container d-flex justify-content-between align-items-center">
    <h4>Gestión de Usuarios</h4>
    <a href="dashboard.html" class="btn-back"><i class="bi bi-arrow-left"></i> Volver</a>
  </div>
</header>

<div class="container mt-4">

  <!-- Sección título -->
  <div class="section-header">
    <div class="title-line"></div>
    <h5 class="section-title">Administrar Usuarios</h5>
  </div>

  <div class="d-flex mb-3 justify-content-between flex-wrap">
    <input id="searchUser" class="form-control" style="max-width:280px" placeholder="Buscar por nombre o cédula...">
    <button class="btn btn-main" id="btnAddUser">+ Agregar Usuario</button>
  </div>

  <div class="content-box">
    <div class="scroll-area">
      <table class="table table-sm">
        <thead>
          <tr>
            <th>Nombre</th>
            <th>Cédula</th>
            <th>Rol</th>
            <th>Grupo</th>
            <th>Correo</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="tbUsers"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- MODAL -->
<div class="modal fade" id="modalUser" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title">Usuario</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <form id="formUser">
          <input type="hidden" id="userId">

          <label class="form-label">Nombre</label>
          <input id="userName" class="form-control" required>

          <label class="form-label mt-2">Cédula (Panamá)</label>
          <input id="userCedula" class="form-control" placeholder="8-1234-5678" required>

          <label class="form-label mt-2">Rol</label>
          <select id="userRol" class="form-select" required>
            <option>Estudiante</option>
            <option>Docente</option>
          </select>

          <label class="form-label mt-2">Grupo (1GS123)</label>
          <input id="userGrupo" class="form-control">

          <label class="form-label mt-2">Correo</label>
          <input id="userCorreo" type="email" class="form-control">

        </form>
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button class="btn btn-main" id="saveUser">Guardar</button>
      </div>

    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<!-- Simulated backend -->
<script src="js/simdb.js"></script>
<script src="js/usuarios.api.js"></script>

<script>
/* ----------------------------- LOCAL STORAGE ------------------------------*/
function getUsers(){ return JSON.parse(localStorage.getItem("users") || "[]"); }
function saveUsers(arr){ localStorage.setItem("users", JSON.stringify(arr)); }

if(!localStorage.getItem("users")){
  saveUsers([
    {id:"u1", nombre:"Jeremy Valdés", cedula:"8-1234-5678", rol:"Estudiante", grupo:"1GS123", correo:"jeremy@utp"},
  {id:"u2", nombre:"Prof. Ejemplo", cedula:"4-9876-3456", rol:"Docente", grupo:"", correo:"ejemplo@utp"}
  ]);
}

/* ----------------------------- RENDER ------------------------------*/
function renderUsers(){
  const tbody = document.getElementById("tbUsers");
  const search = document.getElementById("searchUser").value.toLowerCase();

  tbody.innerHTML = "";

  getUsers().forEach(u=>{
    if(search &&
      !u.nombre.toLowerCase().includes(search) &&
      !u.cedula.toLowerCase().includes(search)
    ) return;

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${u.nombre}</td>
      <td>${u.cedula}</td>
      <td>${u.rol}</td>
      <td>${u.grupo || "-"}</td>
      <td>${u.correo || "-"}</td>
      <td>
        <button class="btn btn-sm btn-outline-primary" onclick="editUser('${u.id}')">Editar</button>
        <button class="btn btn-sm btn-outline-danger ms-2" onclick="delUser('${u.id}')">Eliminar</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

renderUsers();

/* ----------------------------- MODAL ------------------------------*/
const modalUser = new bootstrap.Modal(document.getElementById("modalUser"));

document.getElementById("btnAddUser").addEventListener("click", ()=>{
  document.getElementById("formUser").reset();
  document.getElementById("userId").value = "";
  modalUser.show();
});

function editUser(id){
  const u = getUsers().find(x=>x.id === id);
  document.getElementById("userId").value = u.id;
  document.getElementById("userName").value = u.nombre;
  document.getElementById("userCedula").value = u.cedula;
  document.getElementById("userRol").value = u.rol;
  document.getElementById("userGrupo").value = u.grupo;
  document.getElementById("userCorreo").value = u.correo;
  modalUser.show();
}

function delUser(id){
  if(!confirm("¿Eliminar usuario?")) return;
  saveUsers(getUsers().filter(x=>x.id !== id));
  renderUsers();
}

/* ----------------------------- GUARDAR USUARIO ------------------------------*/
document.getElementById("saveUser").addEventListener("click", ()=>{
  const id = document.getElementById("userId").value;

  const nombre = document.getElementById("userName").value;
  const cedula = document.getElementById("userCedula").value;
  const rol = document.getElementById("userRol").value;
  const grupo = document.getElementById("userGrupo").value;
  const correo = document.getElementById("userCorreo").value;

  const cedulaRegex = /^[1-9]-\d{4}-\d{4}$/;

  if(!cedulaRegex.test(cedula)){
    alert("Cédula inválida. Formato correcto: X-XXXX-XXXX");
    return;
  }

  let users = getUsers();

  if(id){
    const i = users.findIndex(x=>x.id === id);
    users[i] = {id, nombre, cedula, rol, grupo, correo};
  } else {
    users.push({ id: "u" + Date.now(), nombre, cedula, rol, grupo, correo });
  }

  saveUsers(users);
  modalUser.hide();
  renderUsers();
});

document.getElementById("searchUser").addEventListener("input", renderUsers);
</script>

</body>
</html>
